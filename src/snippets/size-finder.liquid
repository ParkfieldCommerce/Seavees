<!-- START SIZE-FINDER -->
<div class="size-finder">
  <div class="size-wrapper">
    <div class="close-btn"></div>
    <div class="container">
      <div class="progress-bar">
        <h3>Find Your Size</h3>
        <div class="bar">
          <div class="checkpoint one completed"></div>
            <div class="completed-step one false"></div>
          <div class="checkpoint two"></div>
            <div class="completed-step two false"></div>
          <div class="checkpoint three"></div>
            <div class="completed-step three false"></div>
          <div class="checkpoint four"></div>
        </div>
      </div>

      <div class="screen one">
        <h2>What <span class="size-recommendor-gender"></span> size do you usually wear?</h2>

        <div class="size-boxes">
        </div>

      </div>
      <div class="screen three">
        <h2>How would you describe the width of your foot?</h2>
        <a class="foot-width" data-width="narrow" href="#">Narrow</a>
        <a class="foot-width" data-width="average" href="#">Average</a>
        <a class="foot-width" data-width="wide" href="#">Wide</a>
      </div>
      <div class="screen four">
        <h2>Does your size sometimes vary?</h2>
        <a class="large" data-variance="smaller" href="#">Yes, Smaller than <span class="size-chosen"></span></a>
        <a class="large" data-variance="larger" href="#">Yes, Larger than <span class="size-chosen"></span></a>
        <a class="large" data-variance="none" href="#">No, I'm always <span class="size-chosen"></span></a>
      </div>
      <div class="screen five">
        <h2>We recommend:</h2>
        <div class="recomended-size"></div>
        <div class="size-recommendor-gender"></div>
        <div class="clear"></div>

        <a href="#" class="arrow-link left" id="size-recommendor-start-over">Start over</a>
        <a href="#" class="arrow-link white" id="size-recommendor-accept-recommended">Select this size</a>

        <p class="disclaimer">Please note we suggest wearing SeaVees with a thin sock for the best fit.</p>
      </div>
    </div>
  </div>
</div>
<!-- END SIZE-FINDER -->
<form>
  <input id="size-recommendor-gender" type="hidden" name="gender" value="">
  <input id="size-recommendor-selected-size" type="hidden" name="size" value="">
  <input id="size-recommendor-selected-width" type="hidden" name="width" value="">
  <input id="size-recommendor-selected-variation" type="hidden" name="width" value="">
</form>

<script>
jQuery(function($){
  {% assign size_string_built = false %}
  // If there is a Size option append each size Number
  {% for option in product.options_with_values %}
    {% unless size_string_built %}
      {% if option.name == 'Size' %}
        {% assign size_string = "" %}
        {% for value in option.values %}

          {% if value contains "ship" %}
            {% assign size = value | split: '-' | first %}
          {% else %}
            // Use the last part of the shoe size to add a size option
            {% assign size = value | split: ' ' | last %}
          {% endif %}

          $('.size-boxes').append('<a class="size-no" href="#" data-variant="{{value}}">{{size}}</a>');

          // Create a comma separated size string to use as array later
          {% if forloop.first == true %}
            {% assign size_string = size_string | append: size %}
          {% else %}
            {% assign size_string = size_string | append: ',' | append: size %}
          {% endif %}

        {% endfor %}
        {% assign size_string_built = true %}
      {% endif %}
    {% endunless %}
  {% endfor %}

  {% if size_string_built == false %}
    // If the size_string_built isn't true it's because there's no "Size" Option.
    // Some Shoes have their size under the generic option "Title" so check there.
    {% for option in product.options_with_values %}
      {% unless size_string_built %}
        {% if option.name == 'Title' %}
          {% assign size_string = "" %}
          {% for value in option.values %}

            {% if value contains "ship" %}
              {% assign size = value | split: '-' | first %}
            {% else %}
              // Use the last part of the shoe size to add a size option
              {% assign size = value | split: ' ' | last %}
            {% endif %}

            $('.size-boxes').append('<a class="size-no" href="#" data-variant="{{value}}">{{size}}</a>');

            // Create a comma separated size string to use as array later
            {% if forloop.first == true %}
              {% assign size_string = size_string | append: size %}
            {% else %}
              {% assign size_string = size_string | append: ',' | append: size %}
            {% endif %}

          {% endfor %}
          {% assign size_string_built = true %}
        {% endif %}
      {% endunless %}
    {% endfor %}
  {% endif %}

  // Create size array from string
  {% assign size_array = size_string | split: ',' %}

  var productGender = $.trim($('.title-gender').text());

  if (productGender == "") {
    // the gender title on the product page was blank so look into the page handle.
    {% if product.handle contains "women" %}
      productGender = "Womens";
    {% elsif product.handle contains "men" %}
      productGenger = "Mens";
    {% else %}
      console.log('No gender on page. No gender in handle. Defaulting to Mens');
      productGender = "Mens";
    {% endif %}
  }

  $('.size-recommendor-gender').text(productGender);

    // Assign gender for use in scripts
    var gender = '{{gender}}';

    $('.js-fitGuideTrigger').click(function(){
      $('.size-finder').fadeIn();
      $('html,body').addClass('noscroll');
    });

    if($('.size-finder').css('display') == 'block')
    {
      $('html,body').addClass('noscroll');
    }

    // Start over
    $('#size-recommendor-start-over').click( function() {
      $("div.size-finder > div > div.container > div.screen").hide();
      $('div.size-finder > div > div.container > div.progress-bar > div > div.completed-step').removeClass('true').addClass('false');
      $('div.size-finder > div > div.container > div.progress-bar > div > div.checkpoint').removeClass('completed');
      $("div.size-finder > div > div.container > div.screen.one").show();
    });

    // Close the fit guide
    $('.close-btn').click(function(){
      $('.size-finder').fadeOut();
      $('html,body').removeClass('noscroll');
    });

    // Click a size
    $('div.screen.one a.size-no').click( function(e) {
      e.preventDefault();
      var selectedSize = $(this).text();
      $('#size-recommendor-selected-size').val(selectedSize);
      $("div.size-finder > div > div.container > div.screen.one").hide();
      $('div.size-finder > div > div.container > div.progress-bar > div > div.completed-step.one.false').removeClass('false').addClass('true');
      $('div.size-finder > div > div.container > div.progress-bar > div > div.checkpoint.two').addClass('completed');
      $('span.size-chosen').text(selectedSize);
      $("div.size-finder > div > div.container > div.screen.three").show();
    });

    // Click a width
    $('div.screen.three a.foot-width').click( function(e) {
      e.preventDefault();
      var selectedWidth = $(this).data('width');
      $('#size-recommendor-selected-width').val(selectedWidth);
      $("div.size-finder > div > div.container > div.screen.three").hide();
      $('div.size-finder > div > div.container > div.progress-bar > div > div.completed-step.two.false').removeClass('false').addClass('true');
      $('div.size-finder > div > div.container > div.progress-bar > div > div.checkpoint.three').addClass('completed');
      $("div.size-finder > div > div.container > div.screen.four").show();
    });

  // Does your size vary?
  $('div.screen.four a.large').click( function(e) {
    e.preventDefault();
    var selectedVariation = $(this).data('variance');
    $('#size-recommendor-selected-variation').val(selectedVariation);
    $("div.size-finder > div > div.container > div.screen.four").hide();
    $('div.size-finder > div > div.container > div.progress-bar > div > div.completed-step.three.false').removeClass('false').addClass('true');
    $('div.size-finder > div > div.container > div.progress-bar > div > div.checkpoint.four').addClass('completed');

    // Make a recomendation here
    var currentGender = gender;
    var currentSize = $('#size-recommendor-selected-size').val();
    var currentWidth = $('#size-recommendor-selected-width').val();
    var currentVariation = $('#size-recommendor-selected-variation').val();

    var newRecommendedSize = recommendSize(currentGender,currentSize,currentWidth,currentVariation);

    $('.screen.five .recomended-size').html(newRecommendedSize);
    $("div.size-finder > div > div.container > div.screen.five").show();

  });

  // Select the recommended size and hide the size recommender
  $('#size-recommendor-accept-recommended').click( function(e) {
    e.preventDefault();
    var newSize = $('.screen.five .recomended-size').text();
    // var modifiedSelectedSize = gender + ' ' + newSize;

    var newVariantTitle = $('a.size-no').filter(function(index) { return $(this).text() === newSize; });
    modifiedSelectedSize = $(newVariantTitle).data('variant');

    // Select the size in thr size selector and trigger Change so optionSelector does it's thing
    $('.js-sizeVariantButton[value="'+modifiedSelectedSize+'"]').trigger('click');
    $('#product-select-option-0').val(modifiedSelectedSize);
    $('#product-select-option-0').trigger('change');
    $('html,body').removeClass('noscroll');

    // optionSelector.selectVariant(selectedVariant);
    $('.size-finder').fadeOut();
  });

  function recommendSize(gender,size,width,variance) {
    $('#size-recommendor-accept-recommended').show();
    var sizeArray = [];
    {% for size in size_array %}
      sizeArray.push("{{size}}");
    {% endfor %}

    var productHandle = "{{ product.handle }}";
    var currentGender = gender.toLowerCase();
    var currentSize = parseFloat(size);
    var currentWidth = width;
    var currentVariation = variance;
    var recommendedSize = currentSize;
    var score = 0.0;
    var contactUs = false;
    var specialDownsize = false;

    // Build a score to determine whether to recommend a different size or not.
    // Not using width any more for size suggestions
    // if (currentWidth == 'wide') {
    //   score = score + .5;
    // } else if (currentWidth == 'narrow') {
    //   score = score - .5;
    // }

    if (currentVariation == 'larger') {
      score = score + .5;
    } else if (currentVariation == 'smaller') {
      score = score - .5;
    }

    // Special down sizing shoes
    if ( productHandle.indexOf('freedom-penny') > -1 || productHandle.indexOf('sunset-strip') > -1 || productHandle.indexOf('legend-sneaker-wintertide') > -1 ) {
      specialDownsize = true;
    }

    if ( specialDownsize ) {
      score = score - 1.0;
    }

    // Adjust the size based on the score from above.
    var existingSizeIndex = sizeArray.indexOf(currentSize.toString());
    if (score >= .5) {
      // bump the size up one size
      if (currentSize == sizeArray[sizeArray.length - 1]) {
        // This is the largest size available contact support cs@seavees.com
        contactUs = true;
      } else {
        recommendedSize = sizeArray[existingSizeIndex + 1]
      }
    } else if (score <= -1.0) {
      // reduce the size one size
      if (currentSize == sizeArray[0]) {
        // This is the smallest size available so do nothing unless this is a special downsize shoe. If so set contact us to true.
        if ( specialDownsize ) {
          contactUs = true;
        }
      } else {
        recommendedSize = sizeArray[existingSizeIndex - 1]
      }
    }

    // check if contactUs is set to true.If so then set the recommededSize to true
    if ( contactUs ) {
      recommendedSize = '<a style="vertical-align:super;width:280px;" href="mailto:cs@seavees.com">CONTACT Seavees Support</a>';
      $('#size-recommendor-accept-recommended').hide();
    }

    return recommendedSize;
  }

});
</script>
