class Theme{
  constructor(){
    this.lazyLoad;
    this.globalInit = this.globalInit.bind(this);
    this.initProductPage = this.initProductPage.bind(this);
    this.initCollectionPage = this.initCollectionPage.bind(this);
  }

  globalInit(){
    this.handleInputValidation();
    this.initHeader();
    this.lazyLoadImages();
  }
  handleInputValidation(){
    let inputs = $('.js-inputCheck input, .js-inputCheck select');
    inputs.change(function(){
      if($(this).val() != ''){
        $(this).parent().addClass('active');
      }else{
        $(this).parent().removeClass('active');
      }
    });
  }
  lazyLoadImages(){
    this.lazyLoad = new Blazy({
      success: function(element){
        setTimeout(function(){
        var parent = element.parentNode;
        parent.className = parent.className.replace(/\bloading\b/,'');
          }, 200);
      }
    });
  }
  initHeader(){
    let menu = $('.js-nav-menu');
    let header = $('.js-header');
    let hamburger = $('.js-hamburger');
    let body = $('body');

    if($(window).width() > 550){
      menu.mouseenter(function(){
        header.addClass('active');
      });
  
      header.mouseleave(function(){
        header.removeClass('active');
      });
    }else{
      hamburger.click(function(){
        header.toggleClass('active');
        body.toggleClass('fixed');
      });

      $('.js-navLinkOne').click(function(e){
        e.preventDefault();
        $(this).parent().toggleClass('active');
      });
    }
  }
  initProductPage(){
    //Product Thumbs Slider
    $('.js-thumbsSlider').slick({
      slidesToShow: 6,
      arrows: false,
      infinite: false,
      responsive:[
        {
          breakpoint: 600,
          settings:{
            slidesToShow: 1,
            dots: true,
            appendDots:'.js-thumbsDots'
          }
        }
      ]
    });
    //Mobile Thumbs Slider
    $('.js-thumbsMobileSlider').slick({
      slidesToShow: 6,
      arrows: false,
      infinite: false,
      responsive:[
        {
          breakpoint: 600,
          settings:{
            slidesToShow: 1,
            dots: true,
            appendDots:'.js-thumbsMobileDots'
          }
        }
      ]
    });
    //Thumbnail Image Switching
    $(document).on('click', '#ProductThumbs img', function(event) {
      $('.js-thumbsImage').removeClass('active');
      $(this).addClass('active');
      concrete.Images.switchImage($('#ProductPhoto img')[0], $(this, event.target)[0]);
    });

    //Handle Size Variant Change
    let sizeVariantButtons = $('.js-sizeVariantButton');
    let sizeOptionSelector = $('.js-selector--Size');

    sizeVariantButtons.click(function(){
      let value = $(this).val();
      sizeVariantButtons.removeClass('active');
      $(this).addClass('active');
      sizeOptionSelector.val(value);
      sizeOptionSelector.trigger('change');
    });
    
    //Related Products Slider
    $('.js-relatedProducts').slick({
      nextArrow:'.js-relatedNext',
      prevArrow:'.js-relatedPrev',
      arrows: true,
      fade: true,
      responsive:[
        {
          breakpoint: 600,
          settings:{
            slidesToShow: 1,
            dots: true,
            arrows: false,
            appendDots:'.js-relatedDots'
          }
        }
      ]
    });
  }
  initCollectionPage(){
    this.initQuickView();
  }
  initQuickView(){
    let quickViewPopup = new Focus('.js-qvPopup');
    $('.js-qvPopupShow').click(function(){
      let url = $(this).val();
      fetchQViewData(url);
    });
    $('.js-qvPopupHide').click(function(){
      quickViewPopup.hide();
    });
    function fetchQViewData(url){
      $.get({
        url:url,
        success:function(data){
          let QVProduct = $('.QView__product');
          let QVDetails = $('.QView__details.hidden');
  
          //Reset Containers
          QVProduct.empty();
          QVDetails.find('.QView__details__right').empty();
  
          //Append Product Form and Images Data
          let productRow = $(data).find('.Product__row');
          QVProduct.append(productRow[0].outerHTML);
          QVProduct.find('.js-thumbsSlider').slick({
            slidesToShow: 6,
            arrows: false,
            infinite: false
          });
  
          //Append Product Details
          let productDetails = $(data).find('.ProductDesc__body.rte');
          QVDetails.find('.QView__details__right').append(productDetails[0].outerHTML);
          QVDetails.find('.QView__details__left a').attr('href',url);
          QVProduct.find('.column.l8.m8.s12').append(QVDetails.clone().removeClass('hidden'));

          //Handle Image Switching
          $(document).on('click', '#ProductThumbs img', function(event) {
            $('.js-thumbsImage').removeClass('active');
            $(this).addClass('active');
            concrete.Images.switchImage($('#ProductPhoto img')[0], $(this, event.target)[0]);
          });
  
          //Handle Swatch Change
          $('.QView .ProductForm__value--color').click(function(e){
            e.preventDefault();
            let url = e.target.href;
            fetchQViewData(url);
          });
          
          //Handle Variant Change
          let json = $(data).find('#ProductJson').html();
          json = JSON.parse(json);
          let addToCart = $('.js-productAdd');
          $('.js-sizeVariantButton').click(function(e){
            let selectedVariantSize = e.target.value;
            let selectedVariant = _.find(json.variants, function(variant){
              return variant.option1 === selectedVariantSize;
            });

            $('.js-sizeVariantButton').removeClass('active');
            $('.js-sizeVariantButton[value="'+selectedVariantSize+'"]').addClass('active');

            if(selectedVariant.available){
              addToCart.attr('data-cart-add', selectedVariant.id);
              addToCart.attr('disabled', false);
              addToCart.text('Add To Cart');
            }else{
              addToCart.attr('disabled', true);
              addToCart.text('Unavailable');
            }
          });

          //Show Popup
          quickViewPopup.show();
        }
      });
    }
  }
  initDreamPage(){
    $('.js-dreamLink').click(function(){
      let sectionId = $(this).val();
      var aTag = $("a[name='"+ sectionId +"']");
      $('html,body').animate({scrollTop: aTag.offset().top},'slow');
    });
  }
}